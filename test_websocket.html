<!DOCTYPE html>
<html>
<head>
    <title>WebSocket 테스트</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin: 10px 0; }
        input, button { margin: 5px; padding: 5px; }
        #messageInput { width: 300px; }
    </style>
</head>
<body>
    <h1>AWS Zendesk Assistant WebSocket 테스트</h1>
    
    <div>
        <button id="connectBtn">연결</button>
        <button id="disconnectBtn" disabled>연결 해제</button>
        <span id="status">연결 안됨</span>
    </div>
    
    <div>
        <input type="text" id="messageInput" placeholder="질문을 입력하세요..." />
        <button id="sendBtn" disabled>전송</button>
    </div>
    
    <div id="messages"></div>

    <script>
        let ws = null;
        let messageId = 1;
        let clientHeartbeat = null;
        let currentStreamingDiv = null;
        
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('messageInput');
        const messages = document.getElementById('messages');
        const status = document.getElementById('status');
        
        function addMessage(message, type = 'info') {
            const div = document.createElement('div');
            div.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        connectBtn.addEventListener('click', () => {
            try {
                ws = new WebSocket('ws://q-slack-lb-353058502.ap-northeast-2.elb.amazonaws.com:8765/ws');
                
                ws.onopen = () => {
                    addMessage('✅ WebSocket 연결 성공!', 'success');
                    status.textContent = '연결됨';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    sendBtn.disabled = false;
                    
                    // 클라이언트 측 하트비트 시작 (25초마다)
                    clientHeartbeat = setInterval(() => {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({type: 'ping', timestamp: new Date().toISOString()}));
                            console.log('Client heartbeat: ping sent');
                        }
                    }, 25000);
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'connected') {
                            addMessage(`서버: ${data.message}`, 'success');
                        } else if (data.type === 'progress') {
                            addMessage(`진행: ${data.message}`, 'info');
                        } else if (data.type === 'message') {
                            // Service Screener 결과 메시지 처리
                            let formattedMessage = data.message
                                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **bold**
                                .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *italic*
                                .replace(/`(.*?)`/g, '<code>$1</code>')            // `code`
                                .replace(/### (.*?)$/gm, '<h3>$1</h3>')           // ### header
                                .replace(/## (.*?)$/gm, '<h2>$1</h2>')            // ## header
                                .replace(/# (.*?)$/gm, '<h1>$1</h1>')             // # header
                                .replace(/\n/g, '<br>');                          // 줄바꿈
                            
                            const div = document.createElement('div');
                            div.style.color = 'green';
                            div.innerHTML = `[${new Date().toLocaleTimeString()}] 메시지:<br><div style="margin-left: 10px; margin-top: 5px;">${formattedMessage}</div>`;
                            messages.appendChild(div);
                            messages.scrollTop = messages.scrollHeight;
                        } else if (data.type === 'streaming_start') {
                            // 스트리밍 시작
                            currentStreamingDiv = document.createElement('div');
                            currentStreamingDiv.style.color = 'green';
                            currentStreamingDiv.innerHTML = `[${new Date().toLocaleTimeString()}] 결과:<br><div id="streaming-content" style="margin-left: 10px; margin-top: 5px;"></div>`;
                            messages.appendChild(currentStreamingDiv);
                            messages.scrollTop = messages.scrollHeight;
                        } else if (data.type === 'streaming_chunk') {
                            // 스트리밍 청크 추가
                            if (currentStreamingDiv) {
                                const contentDiv = currentStreamingDiv.querySelector('#streaming-content');
                                if (contentDiv) {
                                    // 마크다운 스타일 텍스트를 HTML로 간단 변환
                                    let formattedChunk = data.chunk
                                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **bold**
                                        .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *italic*
                                        .replace(/`(.*?)`/g, '<code>$1</code>')            // `code`
                                        .replace(/### (.*?)$/gm, '<h3>$1</h3>')           // ### header
                                        .replace(/## (.*?)$/gm, '<h2>$1</h2>')            // ## header
                                        .replace(/# (.*?)$/gm, '<h1>$1</h1>')             // # header
                                        .replace(/\n/g, '<br>');                          // 줄바꿈
                                    
                                    contentDiv.innerHTML += formattedChunk + '<br>';
                                    messages.scrollTop = messages.scrollHeight;
                                }
                            }
                        } else if (data.type === 'streaming_complete') {
                            // 스트리밍 완료
                            currentStreamingDiv = null;
                            console.log('스트리밍 완료');
                        } else if (data.type === 'result') {
                            // 기존 방식 (짧은 답변용)
                            // 마크다운 스타일 텍스트를 HTML로 간단 변환
                            let formattedAnswer = data.data.answer
                                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **bold**
                                .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *italic*
                                .replace(/`(.*?)`/g, '<code>$1</code>')            // `code`
                                .replace(/### (.*?)$/gm, '<h3>$1</h3>')           // ### header
                                .replace(/## (.*?)$/gm, '<h2>$1</h2>')            // ## header
                                .replace(/# (.*?)$/gm, '<h1>$1</h1>')             // # header
                                .replace(/\n/g, '<br>');                          // 줄바꿈
                            
                            const div = document.createElement('div');
                            div.style.color = 'green';
                            div.innerHTML = `[${new Date().toLocaleTimeString()}] 결과:<br><div style="margin-left: 10px; margin-top: 5px;">${formattedAnswer}</div>`;
                            messages.appendChild(div);
                            messages.scrollTop = messages.scrollHeight;
                        } else if (data.type === 'error') {
                            addMessage(`오류: ${data.message}`, 'error');
                        } else if (data.type === 'ping') {
                            // 서버 ping에 대한 pong 응답
                            ws.send(JSON.stringify({type: 'pong', timestamp: new Date().toISOString()}));
                            console.log('Heartbeat: ping received, pong sent');
                        } else if (data.type === 'pong') {
                            console.log('Heartbeat: pong received');
                        }
                    } catch (e) {
                        addMessage(`메시지 파싱 오류: ${event.data}`, 'error');
                    }
                };
                
                ws.onclose = () => {
                    addMessage('❌ WebSocket 연결 종료', 'error');
                    status.textContent = '연결 안됨';
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    sendBtn.disabled = true;
                    
                    // 클라이언트 하트비트 정리
                    if (clientHeartbeat) {
                        clearInterval(clientHeartbeat);
                        clientHeartbeat = null;
                    }
                };
                
                ws.onerror = (error) => {
                    addMessage(`❌ WebSocket 오류: ${error}`, 'error');
                };
                
            } catch (e) {
                addMessage(`연결 실패: ${e.message}`, 'error');
            }
        });
        
        disconnectBtn.addEventListener('click', () => {
            if (ws) {
                ws.close();
            }
            if (clientHeartbeat) {
                clearInterval(clientHeartbeat);
                clientHeartbeat = null;
            }
        });
        
        sendBtn.addEventListener('click', () => {
            const question = messageInput.value.trim();
            if (!question) {
                addMessage('질문을 입력하세요!', 'error');
                return;
            }
            
            const message = {
                message_id: `test-${messageId++}`,
                question: question,
                timestamp: new Date().toISOString()
            };
            
            try {
                ws.send(JSON.stringify(message));
                addMessage(`전송: ${question}`, 'info');
                messageInput.value = '';
            } catch (e) {
                addMessage(`전송 실패: ${e.message}`, 'error');
            }
        });
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });
    </script>
</body>
</html>