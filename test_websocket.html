<!DOCTYPE html>
<html>
<head>
    <title>WebSocket 테스트</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin: 10px 0; }
        input, button { margin: 5px; padding: 5px; }
        #messageInput { width: 300px; }
    </style>
</head>
<body>
    <h1>AWS Zendesk Assistant WebSocket 테스트</h1>
    
    <div>
        <button id="connectBtn">연결</button>
        <button id="disconnectBtn" disabled>연결 해제</button>
        <span id="status">연결 안됨</span>
    </div>
    
    <div>
        <input type="text" id="messageInput" placeholder="질문을 입력하세요..." />
        <button id="sendBtn" disabled>전송</button>
    </div>
    
    <div id="messages"></div>

    <script>
        let ws = null;
        let messageId = 1;
        
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('messageInput');
        const messages = document.getElementById('messages');
        const status = document.getElementById('status');
        
        function addMessage(message, type = 'info') {
            const div = document.createElement('div');
            div.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        connectBtn.addEventListener('click', () => {
            try {
                ws = new WebSocket('ws://q-slack-lb-353058502.ap-northeast-2.elb.amazonaws.com:8765/ws');
                
                ws.onopen = () => {
                    addMessage('✅ WebSocket 연결 성공!', 'success');
                    status.textContent = '연결됨';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    sendBtn.disabled = false;
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'connected') {
                            addMessage(`서버: ${data.message}`, 'success');
                        } else if (data.type === 'progress') {
                            addMessage(`진행: ${data.message}`, 'info');
                        } else if (data.type === 'result') {
                            addMessage(`결과: ${data.data.answer}`, 'success');
                        } else if (data.type === 'error') {
                            addMessage(`오류: ${data.message}`, 'error');
                        } else if (data.type === 'ping') {
                            // 서버 ping에 대한 pong 응답
                            ws.send(JSON.stringify({type: 'pong', timestamp: new Date().toISOString()}));
                            console.log('Heartbeat: ping received, pong sent');
                        } else if (data.type === 'pong') {
                            console.log('Heartbeat: pong received');
                        }
                    } catch (e) {
                        addMessage(`메시지 파싱 오류: ${event.data}`, 'error');
                    }
                };
                
                ws.onclose = () => {
                    addMessage('❌ WebSocket 연결 종료', 'error');
                    status.textContent = '연결 안됨';
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    sendBtn.disabled = true;
                };
                
                ws.onerror = (error) => {
                    addMessage(`❌ WebSocket 오류: ${error}`, 'error');
                };
                
            } catch (e) {
                addMessage(`연결 실패: ${e.message}`, 'error');
            }
        });
        
        disconnectBtn.addEventListener('click', () => {
            if (ws) {
                ws.close();
            }
        });
        
        sendBtn.addEventListener('click', () => {
            const question = messageInput.value.trim();
            if (!question) {
                addMessage('질문을 입력하세요!', 'error');
                return;
            }
            
            const message = {
                message_id: `test-${messageId++}`,
                question: question,
                timestamp: new Date().toISOString()
            };
            
            try {
                ws.send(JSON.stringify(message));
                addMessage(`전송: ${question}`, 'info');
                messageInput.value = '';
            } catch (e) {
                addMessage(`전송 실패: ${e.message}`, 'error');
            }
        });
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });
    </script>
</body>
</html>