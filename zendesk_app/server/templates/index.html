{% extends "base.html" %}

{% block title %}ZenBot - Zendesk Support Assistant{% endblock %}

{% block content %}
<div class="zenbot-app">
  <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
  <nav class="navbar">
    <div class="nav-brand">
      <span class="brand-icon">âš¡</span>
      <span class="brand-name">ZenBot</span>
    </div>
    <div class="nav-actions">
      {% if ticket_data %}
      <button class="nav-btn" id="ticketInfoBtn" title="í‹°ì¼“ ì •ë³´">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 12H15M9 16H15M17 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V7L17 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      {% endif %}
      <button class="nav-btn" id="chatBtn" title="ì±„íŒ…">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </nav>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <main class="main-area">
    <!-- ëŒ€ì‹œë³´ë“œ ë·° -->
    <div class="dashboard-view active" id="dashboardView">
      <div class="dashboard-header">
        <h1>AWS ë¶„ì„ ë„êµ¬</h1>
        <p>í•„ìš”í•œ ì‘ì—…ì„ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì§ˆë¬¸í•˜ì„¸ìš”</p>
      </div>

      <div class="dashboard-grid">
        <!-- Service Screener ì¹´ë“œ -->
        <div class="feature-card" id="screenerCard">
          <div class="card-top">
            <div class="card-icon-large">ğŸ”</div>
            <h3>Service Screener</h3>
          </div>
          <p>AWS ê³„ì •ì˜ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ìŠ¤ìº”í•˜ê³  ë¶„ì„í•©ë‹ˆë‹¤</p>
          <div class="card-cta">í´ë¦­í•˜ì—¬ ì‹œì‘</div>
        </div>

        <!-- ì›”ê°„ ë³´ê³ ì„œ ì¹´ë“œ -->
        <div class="feature-card" id="reportCard">
          <div class="card-top">
            <div class="card-icon-large">ğŸ“Š</div>
            <h3>ì›”ê°„ ë³´ê³ ì„œ</h3>
          </div>
          <p>AWS ë³´ì•ˆ ìƒíƒœë¥¼ ë¶„ì„í•œ ì›”ê°„ ë³´ê³ ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤</p>
          <div class="card-cta">í´ë¦­í•˜ì—¬ ì‹œì‘</div>
        </div>

        <!-- CloudTrail ì¹´ë“œ -->
        <div class="feature-card" id="cloudtrailCard">
          <div class="card-top">
            <div class="card-icon-large">ğŸ“‹</div>
            <h3>CloudTrail</h3>
          </div>
          <p>AWS ê³„ì •ì˜ í™œë™ ë¡œê·¸ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤</p>
          <div class="card-cta">í´ë¦­í•˜ì—¬ ì‹œì‘</div>
        </div>

        <!-- ì§ì ‘ ì§ˆë¬¸ ì¹´ë“œ -->
        <div class="feature-card" id="openChatBtn">
          <div class="card-top">
            <div class="card-icon-large">ğŸ’¬</div>
            <h3>ì§ì ‘ ì§ˆë¬¸</h3>
          </div>
          <p>AWSì— ëŒ€í•´ ì§ì ‘ ì§ˆë¬¸í•˜ì„¸ìš”</p>
          <div class="card-cta">í´ë¦­í•˜ì—¬ ì±„íŒ… ì‹œì‘</div>
        </div>
      </div>
    </div>

    <!-- ì±„íŒ… ë·° -->
    <div class="chat-view" id="chatView">
      <div class="chat-container">
        <div class="chat-header">
          <div class="chat-title">
            <span class="chat-icon">ğŸ’¬</span>
            <h2>ZenBot ì±„íŒ…</h2>
          </div>
          <button class="close-btn" id="closeChatBtn">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <div class="messages-area" id="messagesContainer">
          <div class="welcome-message">
            <div class="welcome-icon">âš¡</div>
            <h3>ì•ˆë…•í•˜ì„¸ìš”!</h3>
            <p>AWSì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”</p>
          </div>
        </div>
        <div class="chat-input-area">
          <div class="input-wrapper">
            <textarea id="messageInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="1" maxlength="4000"></textarea>
            <button class="send-btn" id="sendButton" disabled>
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          <div class="input-footer">
            <span class="char-count"><span id="charCount">0</span>/4000</span>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- í‹°ì¼“ ì •ë³´ ëª¨ë‹¬ -->
{% if ticket_data %}
<div class="modal" id="ticketModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>í‹°ì¼“ ì •ë³´</h3>
      <button class="modal-close" id="ticketModalClose">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="ticket-field">
        <label>ID</label>
        <span>{{ ticket_data.id }}</span>
      </div>
      <div class="ticket-field">
        <label>ì œëª©</label>
        <span>{{ ticket_data.subject or 'ì œëª© ì—†ìŒ' }}</span>
      </div>
      <div class="ticket-field">
        <label>ìƒíƒœ</label>
        <span class="status-badge status-{{ ticket_data.status }}">{{ ticket_data.status }}</span>
      </div>
      <div class="ticket-field">
        <label>ìš°ì„ ìˆœìœ„</label>
        <span class="priority-badge priority-{{ ticket_data.priority }}">{{ ticket_data.priority }}</span>
      </div>
      <div class="ticket-field">
        <label>ìš”ì²­ì</label>
        <span>{{ ticket_data.requesterName }}</span>
      </div>
    </div>
  </div>
</div>
{% endif %}
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-content">
    <div class="spinner"></div>
    <span>ì²˜ë¦¬ ì¤‘...</span>
  </div>
</div>

<!-- Service Screener ëª¨ë‹¬ -->
<div class="modal" id="screenerModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ” Service Screener</h3>
      <button class="modal-close" id="screenerModalClose">Ã—</button>
    </div>
    <div class="modal-body">
      <p class="modal-desc">AWS ê³„ì •ì˜ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ìŠ¤ìº”í•˜ê³  ë¶„ì„í•©ë‹ˆë‹¤</p>
      <div class="form-group">
        <label>ê³„ì • ID</label>
        <input type="text" id="screenerAccountId" placeholder="ì˜ˆ: 123456789012" maxlength="12">
      </div>
      <button class="modal-action-btn" id="runScreenerBtn">ì‹¤í–‰</button>
    </div>
  </div>
</div>

<!-- ì›”ê°„ ë³´ê³ ì„œ ëª¨ë‹¬ -->
<div class="modal" id="reportModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ“Š ì›”ê°„ ë³´ê³ ì„œ</h3>
      <button class="modal-close" id="reportModalClose">Ã—</button>
    </div>
    <div class="modal-body">
      <p class="modal-desc">AWS ë³´ì•ˆ ìƒíƒœë¥¼ ë¶„ì„í•œ ì›”ê°„ ë³´ê³ ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤</p>
      <div class="form-group">
        <label>ê³„ì • ID</label>
        <input type="text" id="reportAccountId" placeholder="ì˜ˆ: 123456789012" maxlength="12">
      </div>
      <div class="form-group">
        <label>ê¸°ê°„</label>
        <select id="reportMonth">
          <option value="">ì´ë²ˆ ë‹¬</option>
          <option value="last-month">ì§€ë‚œ ë‹¬</option>
        </select>
      </div>
      <button class="modal-action-btn" id="generateReportBtn">ìƒì„±</button>
    </div>
  </div>
</div>

<!-- CloudTrail ëª¨ë‹¬ -->
<div class="modal" id="cloudtrailModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ“‹ CloudTrail</h3>
      <button class="modal-close" id="cloudtrailModalClose">Ã—</button>
    </div>
    <div class="modal-body">
      <p class="modal-desc">AWS ê³„ì •ì˜ í™œë™ ë¡œê·¸ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤</p>
      <div class="form-group">
        <label>ê³„ì • ID</label>
        <input type="text" id="cloudtrailAccountId" placeholder="ì˜ˆ: 123456789012" maxlength="12">
      </div>
      <div class="form-group">
        <label>ì´ë²¤íŠ¸ ìœ í˜•</label>
        <select id="eventType">
          <option value="">ëª¨ë“  ì´ë²¤íŠ¸</option>
          <option value="critical">ì¤‘ìš” ì´ë²¤íŠ¸</option>
          <option value="delete">ì‚­ì œ ì´ë²¤íŠ¸</option>
        </select>
      </div>
      <button class="modal-action-btn" id="queryCloudtrailBtn">ì¡°íšŒ</button>
    </div>
  </div>
</div>

<!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
<div class="toast-container" id="toastContainer"></div>

<!-- ìŠ¤í¬ë¦½íŠ¸ -->
<script>
  window.ticketData = {{ ticket_data | tojson if ticket_data else 'null' }};
  
  // WebSocket URLì„ HTTPSë¡œ ë³€í™˜ (ì  ë°ìŠ¤í¬ëŠ” HTTPSë§Œ í—ˆìš©)
  let websocketUrl = "{{ websocket_url }}";
  websocketUrl = websocketUrl.replace(/^ws:/, 'wss:').replace(/^http:/, 'https:');
  window.websocketUrl = websocketUrl;
  
  console.log('[DEBUG] WebSocket URL:', window.websocketUrl);
</script>
{% endblock %}
