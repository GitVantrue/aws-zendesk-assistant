{% extends "base.html" %}

{% block title %}ZenBot - Zendesk Support Assistant{% endblock %}

{% block content %}
<div class="zenbot-app">
  <!-- 네비게이션 바 -->
  <nav class="navbar">
    <div class="nav-brand" id="navBrand" style="cursor: pointer;">
      <span class="brand-icon">⚡</span>
      <span class="brand-name">ZenBot</span>
    </div>
    <div class="nav-actions">
      <button class="nav-btn" id="chatBtn" title="채팅">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </nav>

  <!-- 메인 콘텐츠 -->
  <main class="main-area">
    <!-- 대시보드 뷰 -->
    <div class="dashboard-view active" id="dashboardView">
      <div class="dashboard-header">
        <h1>AWS 분석 도구</h1>
        <p>필요한 작업을 선택하거나 직접 질문하세요</p>
      </div>

      <div class="dashboard-grid">
        <!-- Service Screener 카드 -->
        <div class="feature-card" id="screenerCard">
          <div class="card-top">
            <div class="card-icon-large">🔍</div>
            <h3>Service Screener</h3>
          </div>
          <p>AWS 계정의 모든 서비스를 스캔하고 분석합니다</p>
          <div class="card-cta">클릭하여 시작</div>
        </div>

        <!-- 월간 보고서 카드 -->
        <div class="feature-card" id="reportCard">
          <div class="card-top">
            <div class="card-icon-large">📊</div>
            <h3>월간 보고서</h3>
          </div>
          <p>AWS 보안 상태를 분석한 월간 보고서를 생성합니다</p>
          <div class="card-cta">클릭하여 시작</div>
        </div>

        <!-- CloudTrail 카드 -->
        <div class="feature-card" id="cloudtrailCard">
          <div class="card-top">
            <div class="card-icon-large">📋</div>
            <h3>CloudTrail</h3>
          </div>
          <p>AWS 계정의 활동 로그를 조회합니다</p>
          <div class="card-cta">클릭하여 시작</div>
        </div>

        <!-- 직접 질문 카드 -->
        <div class="feature-card" id="openChatBtn">
          <div class="card-top">
            <div class="card-icon-large">💬</div>
            <h3>직접 질문</h3>
          </div>
          <p>AWS에 대해 직접 질문하세요</p>
          <div class="card-cta">클릭하여 채팅 시작</div>
        </div>
      </div>
    </div>

    <!-- 월간 보고서 모달 -->
    <div class="modal" id="reportModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>📊 월간 보안 보고서</h3>
          <button class="modal-close" id="reportModalClose">×</button>
        </div>
        <div class="modal-body">
          <p class="modal-desc">AWS 계정의 보안 상태를 분석한 월간 보고서를 생성합니다.</p>
          
          <div class="form-group">
            <label>계정 ID</label>
            <input type="text" id="reportAccountId" placeholder="예: 950027134314" maxlength="12">
          </div>
          
          <div class="form-group">
            <label>분석 기간</label>
            <input type="month" id="reportMonth">
          </div>
          
          <button class="modal-action-btn" id="generateReportBtn">보고서 생성</button>
          
          <div id="reportResult" style="display: none; margin-top: 16px; padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border: 1px solid rgba(16, 185, 129, 0.3);">
            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">생성된 보고서:</p>
            <a id="reportLink" href="#" target="_blank" style="color: #818cf8; text-decoration: underline; word-break: break-all;"></a>
          </div>
        </div>
      </div>
    </div>

    <!-- 채팅 뷰 -->
    <div class="chat-view" id="chatView">
      <div class="chat-container">
        <div class="chat-header">
          <div class="chat-title">
            <span class="chat-icon">💬</span>
            <h2>ZenBot 채팅</h2>
          </div>
          <button class="close-btn" id="closeChatBtn">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <div class="messages-area" id="messagesContainer">
          <div class="welcome-message">
            <div class="welcome-icon">⚡</div>
            <h3>안녕하세요!</h3>
            <p>AWS에 대해 궁금한 점을 물어보세요</p>
          </div>
        </div>
        <div class="chat-input-area">
          <div class="input-wrapper">
            <textarea id="messageInput" placeholder="질문을 입력하세요..." rows="1" maxlength="4000"></textarea>
            <button class="send-btn" id="sendButton" disabled>
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          <div class="input-footer">
            <span class="char-count"><span id="charCount">0</span>/4000</span>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- 토스트 컨테이너 -->
<div class="toast-container" id="toastContainer"></div>

<!-- 로딩 오버레이 (사용하지 않음 - 진행 메시지로 대체) -->
<!-- <div class="loading-overlay" id="loadingOverlay">
  <div class="loading-content">
    <div class="spinner"></div>
    <p id="loadingText">처리 중...</p>
  </div>
</div> -->

<!-- 스크립트 -->
<script>
  // WebSocket URL을 HTTPS로 변환 (젠데스크는 HTTPS만 허용)
  let websocketUrl = "{{ websocket_url }}";
  websocketUrl = websocketUrl.replace(/^ws:/, 'wss:').replace(/^http:/, 'https:');
  window.websocketUrl = websocketUrl;
  
  console.log('[DEBUG] WebSocket URL:', window.websocketUrl);
  console.log('[DEBUG] 버전: 3.0.3');
</script>
{% endblock %}
